# Nexus
> Nexus is a Rust CLI package (`opennexus`) centered on the `opennexus` command for project bootstrap/update/uninstall, plus a `docs-sync` command that generates Rust symbol reference docs into the docs site. It also ships embedded governance assets under `.nexus/` that drive command/rule workflows.

Agents should use this file as an operational map: pick the correct domain section first, execute the shortest matching playbook, and only call APIs and paths that are verified here against the current repository.

## Agent Operating Rules
- Prefer source-of-truth edits in `.nexus/**`; treat `.opencode/command/**` as generated symlinks created by setup.
- Keep behavior aligned across `text` and `json` output modes when changing CLI command handlers.
- Verify paths and symbols before modifying docs or usage guidance; do not invent commands or modules.
- If Rust public docs/symbols change, run docs sync workflow so `docs/content/docs/reference/**` is regenerated.
- Preserve existing command topology: `setup`, `update`, `uninstall` under `src/commands/**`.

## Environment and Version Constraints
- Rust workspace is single-member (`[workspace] members = ["."]`) in `Cargo.toml`.
- Package metadata: `opennexus` v`0.1.3`, edition `2021` in `Cargo.toml`.
- Executables: `opennexus` (`src/main.rs`) and `docs-sync` (`src/bin/docs_sync.rs`).
- Build config in `.cargo/config.toml`: `rustc-wrapper = "sccache"`, incremental disabled for dev/release, macOS ad-hoc codesign rustflags for `aarch64-apple-darwin` and `x86_64-apple-darwin`.
- Docs app stack in `docs/package.json`: Next `16.1.6`, Fumadocs (`fumadocs-core`, `fumadocs-mdx`, `fumadocs-ui`), Bun used by `just docs`.

## Quick Task Playbooks
- **Add or adjust CLI behavior**
  1. Update CLI shape in `src/cli.rs` if flags/subcommands change.
  2. Implement handler logic in `src/commands/*.rs`.
  3. Wire dispatch in `src/main.rs` and exports in `src/lib.rs` / `src/commands/mod.rs`.
  4. Run `just fmt-check && just clippy && cargo test`.
- **Change setup asset extraction**
  1. Edit extraction logic in `src/commands/setup.rs`.
  2. If context selection changes, verify `.nexus/context/.extract-allowlist`.
  3. Validate symlink behavior for `.opencode/command`.
  4. Run `just setup-test`.
- **Refresh generated docs reference**
  1. Update Rust docs/comments in `src/**/*.rs`.
  2. Run `just docs-sync`.
  3. Confirm no drift with `just docs-sync-check`.
- **Work on docs routes/source**
  1. Update loader/routes in `docs/src/lib/source.ts` or `docs/src/app/**`.
  2. Run `just docs` and verify `/docs`, `/llms.txt`, `/llms-full.txt`.

## Getting Started
- Install dependencies and run local setup flow: `just dev` (runs `cargo run --bin opennexus -- setup`).
- Build binaries: `just build` (or `just build-release` for release build).
- Run docs locally: `just docs`.
- Validate baseline checks before handoff: `just fmt-check`, `just clippy`, `cargo test`, and `just docs-sync-check` when Rust docs changed.

## Workspace Overview
- `src/` - Rust CLI/library code (`cli`, `commands`, `output`) and `bin/docs_sync.rs`.
- `docs/` - Next.js + Fumadocs documentation app.
- `docs/content/docs/reference/` - generated Rust symbol reference pages managed by `docs-sync`.
- `.nexus/rules/` - governance rules (including `.nexus/rules/llms-txt.md`).
- `.nexus/commands/` - command specs; symlinked into `.opencode/command/`.
- `.nexus/context/` - context artifacts and extraction allowlist (`.extract-allowlist`).
- `.nexus/templates/` - templates used by setup/distribution.
- `justfile` + `justfiles/**` - developer task recipes.

## Domain: Rust CLI Core
- Entry command dispatches `Cli` commands from `src/main.rs` to `run_setup`, `run_update`, `run_uninstall`.
- CLI schema in `src/cli.rs`: `Cli`, `Commands::{Setup,Update,Uninstall}`, `OutputFormat::{Text,Json}` with global `--format` default `text`.
- Setup logic in `src/commands/setup.rs` extracts embedded `.nexus` assets and creates `.opencode/command` symlinks (or copies on non-Unix).
- Context extraction is allowlist-based via `.nexus/context/.extract-allowlist`; fallback default is `fumadocs` if allowlist cannot be read/parsed.
- Update/uninstall shell out to cargo:
  - update: `cargo install opennexus --bin opennexus --force` (`src/commands/update.rs`)
  - uninstall: `cargo uninstall --package opennexus --bin opennexus` (`src/commands/uninstall.rs`)
- Output helpers in `src/output.rs`: `print_success`, `print_info`, `print_error`.

## Domain: Docs Platform and Docs Sync
- Docs app root is `docs/`; content source is `docs/content/docs`.
- Source loader in `docs/src/lib/source.ts` uses `loader({ baseUrl: '/docs', source: docs.toFumadocsSource(), plugins: [lucideIconsPlugin()] })`.
- Docs page route is `docs/src/app/docs/[[...slug]]/page.tsx` via `source.getPage` and `source.generateParams`.
- LLM text routes:
  - `docs/src/app/llms.txt/route.ts` (index of pages)
  - `docs/src/app/llms-full.txt/route.ts` (full concatenated page text)
- Rewrite for MDX extraction in `docs/next.config.mjs`: `/docs/:path*.mdx` -> `/llms.mdx/docs/:path*`.
- `docs-sync` command (`src/bin/docs_sync.rs`) supports `sync|check` (default `sync`), scans `src/**/*.rs`, regenerates `docs/content/docs/reference`, and checks drift.

## Domain: Governance and Config Assets
- `llms.txt` generation rules live at `.nexus/rules/llms-txt.md`.
- Additional rule files are under `.nexus/rules/*.md`.
- Command specs are under `.nexus/commands/*.md`.
- `.opencode/command/*.md` are symlinks pointing to `.nexus/commands/*.md`.
- Context artifacts exist under `.nexus/context/` with project folders `fumadocs`, `nexus`, `nexus-cli`, plus `_reference`.
- Templates are under `.nexus/templates/*`.

## Domain: Developer Workflow
- Root `justfile` imports recipes from `justfiles/**`.
- Common tasks include `dev`, `docs`, `docs-sync`, `build`, `build-release`, `check`, `clippy`, `fmt`, `fmt-check`, `docs-sync-check`, `clean`, `install`, `uninstall`, `pub`, `setup`, `setup-test`.
- `justfiles/development/docs.just` runs docs dev server with Bun and logs to `logs/docs.log`; `docs-sync` uses `cargo run --bin docs-sync -- sync`.
- Git hooks:
  - `.cargo-husky/hooks/pre-commit`: fmt check + clippy (all-targets/all-features)
  - `.cargo-husky/hooks/pre-push`: fmt check + clippy (all-targets/all-features) + `cargo test`

## Usage Cards

### Command Card: `opennexus setup`
- Use when: initializing or refreshing local Nexus assets in the current project.
- Enable/Install: install CLI via `just install` or run locally with `cargo run --bin opennexus -- setup`.
- Import/Invoke: `opennexus setup --format text` or `opennexus setup --format json`.
- Minimal flow:
  1. Run `opennexus setup`.
  2. Verify `.nexus/.version` exists.
  3. Verify `.opencode/command/*.md` links exist.
- Key APIs: `run_setup`, `extract_nexus_directory`, `create_command_symlinks`, `context_projects_allowlist`.
- Pitfalls: editing `.opencode/command` directly; expecting all `.nexus/context/*` projects to extract without allowlist entry.
- Source: `src/commands/setup.rs`, `.nexus/context/.extract-allowlist`.

### Command Card: `opennexus update`
- Use when: upgrading installed `opennexus` command from crates.io.
- Enable/Install: requires working Rust/cargo toolchain in PATH.
- Import/Invoke: `opennexus update --format text|json`.
- Minimal flow:
  1. Run `opennexus update`.
  2. Confirm cargo install exits successfully.
  3. Re-run `opennexus --version`.
- Key APIs: `run_update`, `std::process::Command::args(["install","opennexus","--bin","opennexus","--force"])`.
- Pitfalls: assuming this updates local source checkout; running without cargo installed.
- Source: `src/commands/update.rs`.

### Command Card: `opennexus uninstall`
- Use when: removing globally installed `opennexus` command.
- Enable/Install: requires cargo installation metadata to include `opennexus`.
- Import/Invoke: `opennexus uninstall --format text|json`.
- Minimal flow:
  1. Run `opennexus uninstall`.
  2. Confirm cargo uninstall exits successfully.
  3. Verify `opennexus` is no longer available globally.
- Key APIs: `run_uninstall`, `std::process::Command::args(["uninstall","--package","opennexus","--bin","opennexus"])`.
- Pitfalls: expecting local repository files to be removed; uninstalling wrong package name.
- Source: `src/commands/uninstall.rs`.

### Command Card: `docs-sync`
- Use when: Rust symbols/docs changed and generated reference pages must be synced or checked.
- Enable/Install: run from repo root with Rust toolchain; wrapper recipes `just docs-sync` / `just docs-sync-check`.
- Import/Invoke: `cargo run --bin docs-sync -- sync` or `cargo run --bin docs-sync -- check`.
- Minimal flow:
  1. Update Rust sources under `src/`.
  2. Run sync mode to regenerate reference docs.
  3. Run check mode in CI/local verification.
- Key APIs: `run`, `collect_rs_files`, `parse_rust_file`, `render_reference_tree`, `diff_trees`.
- Pitfalls: editing `docs/content/docs/reference/**` manually; running from non-repo-root directory.
- Source: `src/bin/docs_sync.rs`, `justfiles/verification/docs-sync-check.just`.

## API Reference
- CLI/public Rust exports in `src/lib.rs`:
  - `Cli`, `Commands`, `OutputFormat`
  - `run_setup`, `run_update`, `run_uninstall`
- CLI schema in `src/cli.rs`:
  - `Cli::parse_args()`
  - enum `Commands::{Setup,Update,Uninstall}`
  - enum `OutputFormat::{Text,Json}`
- Command handlers:
  - `run_setup` in `src/commands/setup.rs`
  - `run_update` in `src/commands/update.rs`
  - `run_uninstall` in `src/commands/uninstall.rs`
- Output utilities in `src/output.rs`:
  - `print_success`
  - `print_info`
  - `print_error`
- Docs route handlers:
  - `GET` in `docs/src/app/llms.txt/route.ts`
  - `GET` in `docs/src/app/llms-full.txt/route.ts`
  - search `GET` from `createFromSource` in `docs/src/app/api/search/route.ts`

## Common Pitfalls
- Updating `.opencode/command/*.md` directly instead of `.nexus/commands/*.md` (links are regenerated by setup).
- Forgetting allowlist behavior in setup; only allowlisted context projects under `.nexus/context/` are extracted.
- Treating `opennexus update`/`opennexus uninstall` as repo-mutating commands; they invoke cargo install metadata operations.
- Skipping `docs-sync` after Rust doc/symbol changes, causing drift in `docs/content/docs/reference/`.
- Changing docs route behavior without validating `docs/src/lib/source.ts` loader assumptions (`baseUrl: '/docs'` and plugins).

## Optional
- Use `just setup-test` to validate setup behavior in a fresh `tmp/` directory.
- Use `just pub` carefully: it can auto-commit changes, bump version, create a tag, push (if remote exists), then publish.
- For docs route checks, verify `/llms.txt` and `/llms-full.txt` responses after `just docs`.
